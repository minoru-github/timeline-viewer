# Timeline Viewer

**概要**

ブラウザで動作するシーケンス／タイムライン可視化ツールです。スレッド単位の JSON を読み込み、依存関係に基づくガント風タイムラインを描画し、対話的に編集・検証・エクスポートできます。

**機能**

- スレッド毎の JSON 読み込みと自動検証（時間値は「0 未満」を無効と判定、from/to 整合、同一スレッド上の順序不明検出、循環検出）。
- DOM と SVG によるタイムライン描画（レーン＝スレッド、ボックス＝モジュール、矢印＝依存関係）。
- 依存関係の作成・削除（選択可能なヒット領域で扱いやすくしています）。
- モジュールの追加・編集（モーダルで Thread/Name/Time/From/To を編集可能）。
- Add Module の既定値: `Thread` にフォーカス、`Time` の初期値は `0`、Enter キーで作成をトリガーできます。
- From/To リストの表示ルール:
  - `Time > 0` のときは同一スレッドのモジュールのみ表示。
  - `Time == 0` のときは同一スレッドは全モジュール表示、他スレッドは `Time == 0` のモジュールのみ表示。
  - 設定変更時は既存の選択が新しい候補に残る場合、自動で再選択されます。編集中のモジュール自身はリストから除外されます。
- ドラッグ＆ドロップによるスレッド再割当と自動リスケジューリング（近傍との順序調整・衝突回避を行います）。
- Undo / Redo による操作の取り消し／やり直し。
- 縦表示（上→下）モードのサポート。表示向きは切替ボタンでトグルします。
- time=0 のモジュール表現: メタ表示は非表示、描画サイズは `Time=1` 相当で配置、角は角ばせ（丸め無し）、背景は薄いグレーで視認性を確保。
- 時間表示は小数最大3桁まで（例: `1.234`）。
- 図の SVG エクスポートおよび編集後のスレッド別 JSON をブラウザからダウンロード（ローカル書き込みは行いません）。

**操作方法**

- ファイル読み込み: 画面上部のファイル入力で複数の `.json` ファイルを選択します（各ファイルはそのスレッドのモジュール配列）。選択すると自動でパース・検証・レンダリングが行われます。
- 依存作成: 依存元 → 依存先 の順でクリックします。依存作成は **Shift を押しながら** 行います（Shift 押下中に送信元をクリック、続けて送信先をクリックすると矢印が作成されます）。
- 編集トリガ: モジュールの設定変更は **Ctrl + 左クリック** でモーダルを開きます（Shift は依存作成に使います）。
- 矢印削除: 矢印（線）をクリックして選択し、Delete キーを押すか `Delete Arrow` ボタンを押します。
- モジュール追加:
  1. `Add Module` ボタンを押してモーダルを開きます（`Thread` フィールドに自動でフォーカス、`Time` は `0` が初期値）。
  2. `Module name` と必要な `From` / `To` を設定し、Enter を押すか `作成` ボタンをクリックして追加します。
- モジュール編集（設定変更）:
  1. 対象モジュールを Ctrl + 左クリックして編集モーダルを開きます。
  2. `Thread` / `Module name` / `Time` / `From` / `To` を編集します。編集時、`From`/`To` の候補は `Time` の値に応じて動的にフィルタされ、編集前に選ばれていた候補は可能なら自動で復元されます。自分自身は候補リストから除外されます。
  3. Enter を押すか `保存` をクリックして変更を反映します。
- モジュール移動: モジュールをドラッグして別のレーン（スレッド）にドロップします。ドロップ位置に基づき近傍のモジュールと順序調整を行い、重なりを回避します。
- 表示ハイライト: モジュールをクリックすると、そのモジュールと直接つながる矢印・モジュールが強調され、他は薄くなります。もう一度クリックすると選択解除されます。

**ファイル構成（主要ファイル）**

- `index.html` — UI とコントロール
- `styles.css` — 見た目の定義
- `app.js` — パーサ、スケジューラ、レンダラ、インタラクション、エクスポート機能の本体

---

### モジュールの追加と編集（使い方）

- 新規モジュールの追加:
  1. 画面上部の `Add Module` ボタンをクリックします。
  2. 表示されるモーダルで「Thread（スレッド）」「Module（モジュール名）」「Time（任意）」および `from` / `to` を設定します。
  3. `作成`（または `Create`）を押すとモジュールが追加され、タイムラインは自動で再配置されます。必要なら `Undo` で取り消せます。

  - 既存モジュールの設定変更:
  1. タイムライン上の編集したいモジュールを Ctrl を押しながら左クリックします。
  2. 表示されるモーダルで名前、スレッド、時間、依存関係（from/to）を変更します。
  3. `保存`（または `Save`）を押すと変更が反映され、自動でリスケジュールされます。変更は `Undo` で取り消せます。

**エクスポートと出力ポリシー**

- 図や編集済みデータはブラウザのダウンロードとして出力されます。
- リポジトリには `.gitignore` に `output/` が登録されています。

**ローカルでの開発メモ**

- 主要な編集箇所は `app.js` です。レンダリング、ドラッグ＆ドロップ、Undo/Redo、検証ロジックはここに集約されています。

---

## json仕様

入力フォーマット:

- ファイル名（拡張子 `.json` を除く）が `thread` 名になります。例: `0.json` → thread = "0"。
- 各ファイルは、そのスレッド内で実行される複数のモジュールを配列で記述します。
- 各モジュールは以下のオブジェクト形式です:

```
{
  "module": "a",    // モジュール名
  "time": 2,        // 実行時間（ミリ秒）
  "from": [
     {
      "thread":"0",
      "module":"x"
      },
      ... 
  ],
  "to": [
    {
      "thread":"1",
      "module":"y"
      }
      ,
    ...
  ]
}
```

- `from` / `to` 配列には、相手の `thread` と `module` の両方を指定してください（同一スレッドなら同じ `thread` 値を指定します）。`"none"` 相当は空配列にしてください。

注意事項:

- JSON が不正な場合はポップアップでエラーが表示されます。
- 検証エラー（無効な時間値、from/to の不整合、同一スレッド上の順序不明、循環依存など）はポップアップとタイムライン下の「エラーパネル」に一覧表示されます。
- 検証エラーがあっても可能な限りタイムラインはレンダリングされます（警告扱い）。
- `Export SVG` は現在ページ上に表示されているエラーパネルの内容も埋め込むため、SVG にエラー一覧が含まれます。
- サンプルデータは `ok_sample_0/`, `ok_sample_1/`, `ng_sample_0/`, `ng_sample_1/`フォルダ内の JSON を参照してください（各ファイルは thread 単位でモジュール配列を含みます）。
