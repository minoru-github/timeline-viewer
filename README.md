# Timeline Viewer

**概要**

ブラウザで動作するシーケンス／タイムライン可視化ツールです。スレッド単位の JSON を読み込み、依存関係に基づくガント風タイムラインを描画し、対話的に編集・検証・エクスポートできます。

**機能**

- スレッド毎の JSON 読み込みと自動検証（time>0、from/to 整合、同一スレッド順序の曖昧性、循環検出）。
- DOM と SVG によるタイムライン描画（レーン＝スレッド、ボックス＝モジュール、矢印＝依存関係）。
- 依存関係の作成・削除。
- モジュールの追加・編集。
- ドラッグ＆ドロップによるスレッド再割当と自動リスケジューリング。
- Undo / Redo による操作の取り消し／やり直し。
- 図の SVG エクスポートおよび編集後のスレッド別 JSON をブラウザからダウンロード（ローカル保存のみ）。

**操作方法（短い参照）**

- ファイル読み込み: 画面上部のファイル入力で複数の `.json` ファイルを選択します（各ファイルはそのスレッドのモジュール配列）。選択すると自動でパース・検証・レンダリングが行われます。
- 依存作成: 依存元モジュールを Ctrl キーを押しながらクリックしてから、依存先モジュールを Ctrl 押しつつクリックします（2 回目のクリックで A → B が作成されます）。
- 矢印削除: 矢印をクリックして選択し、Delete キーを押すか `Delete Arrow` ボタンを押します。
- モジュール追加: `Add Module` ボタンを押してモーダルを開き、Thread / Module / Time / From / To を入力して `作成`（Create）を押します。
- モジュール編集: タイムライン上のモジュールを Shift+クリックすると編集モーダルが開きます。変更後に `保存` を押すと反映されます。
- モジュール移動: モジュールをドラッグして別のレーン（スレッド）にドロップします。ドロップ位置により近傍のモジュールと自動で順序調整されます。
- 表示解除: タイムライン上でモジュールをクリックするとそのモジュールと直接つながる矢印・モジュール以外が薄くなり、選択が解除されると元に戻ります。

**ファイル構成（主要ファイル）**

- `index.html` — UI とコントロール
- `styles.css` — 見た目の定義
- `app.js` — パーサ、スケジューラ、レンダラ、インタラクション、エクスポート機能の本体

---

### モジュールの追加と編集（使い方）

- 新規モジュールの追加:
  1. 画面上部の `Add Module` ボタンをクリックします。
  2. 表示されるモーダルで「Thread（スレッド）」「Module（モジュール名）」「Time（任意）」および `from` / `to` を設定します。
  3. `作成`（または `Create`）を押すとモジュールが追加され、タイムラインは自動で再配置されます。必要なら `Undo` で取り消せます。

- 既存モジュールの設定変更:
  1. タイムライン上の編集したいモジュールをダブルクリックします。
  2. 表示されるモーダルで名前、スレッド、時間、依存関係（from/to）を変更します。
  3. `保存`（または `Save`）を押すと変更が反映され、自動でリスケジュールされます。変更は `Undo` で取り消せます。

**エクスポートと出力ポリシー**

- 図や編集済みデータはブラウザのダウンロードとして出力されます。
- リポジトリには `.gitignore` に `output/` が登録されています。

**ローカルでの開発メモ**

- 主要な編集箇所は `app.js` です。レンダリング、ドラッグ＆ドロップ、Undo/Redo、検証ロジックはここに集約されています。

---

## json仕様

入力フォーマット:

- ファイル名（拡張子 `.json` を除く）が `thread` 名になります。例: `0.json` → thread = "0"。
- 各ファイルは、そのスレッド内で実行される複数のモジュールを配列で記述します。
- 各モジュールは以下のオブジェクト形式です:

```
{
  "module": "a",    // モジュール名
  "time": 2,        // 実行時間（ミリ秒）
  "from": [
     {
      "thread":"0",
      "module":"x"
      },
      ... 
  ],
  "to": [
    {
      "thread":"1",
      "module":"y"
      }
      ,
    ...
  ]
}
```

- `from` / `to` 配列には、相手の `thread` と `module` の両方を指定してください（同一スレッドなら同じ `thread` 値を指定します）。`"none"` 相当は空配列にしてください。

注意事項:

- JSON が不正な場合はポップアップでエラーが表示されます。
- 検証エラー（無効な時間値、from/to の不整合、同一スレッド上の順序不明、循環依存など）はポップアップとタイムライン下の「エラーパネル」に一覧表示されます。
- 検証エラーがあっても可能な限りタイムラインはレンダリングされます（警告扱い）。
- `Export SVG` は現在ページ上に表示されているエラーパネルの内容も埋め込むため、SVG にエラー一覧が含まれます。
- サンプルデータは `ok_sample_0/`, `ok_sample_1/`, `ng_sample_0/`, `ng_sample_1/`フォルダ内の JSON を参照してください（各ファイルは thread 単位でモジュール配列を含みます）。
